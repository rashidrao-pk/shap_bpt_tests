# ShapBPT: Image Feature Attributions using Data-Aware Binary Partition Trees  
### Supplementary Material ‚Äì Facial Attribute Localization (Experiment E5)

This directory contains all supplementary resources for **Experiment E5** from the paper:

> **_ShapBPT: Image Feature Attributions using Data-Aware Binary Partition Trees_**

Experiment E5 focuses on **facial attribute localization** using the **CelebAMask-HQ dataset**, evaluating ShapBPT against several popular XAI baselines.  
It includes models, notebooks, CSV results, saliency heatmaps, IoU comparisons, and full ablation studies using multiple background replacement strategies.

---

# üìö Dataset

The CelebA experiments use:

### **CelebAMask-HQ**
Download from the official repository:  
https://github.com/switchablenorms/CelebAMask-HQ

After downloading, place the dataset inside the appropriate folder structure expected by the notebooks (typically under `notebooks/CelebA_experiments/`).

---

# üß† Model Setup

The facial attribute classifier used in this experiment is publicly provided by **@kartikbatra**.

### **1. Download the Pretrained Model**
Model link:  
https://www.kaggle.com/code/kartikbatra/multilabelclassification/notebook

### **2. Place the Model File**
Download the trained weights file and place it as:

```
models/model.pth
```

This is required for running the notebooks.

---

# üìÅ Folder Structure

The main experiment folder is:

```
CelebA_experiments/
```

It contains the following components:

---

## **1. Notebooks ‚Äì `notebooks/CelebA_experiments/`**

This directory contains 3 primary notebooks:

### **a. N1_Run_experiments_CelebA.ipynb**
Generates:
- heatmaps  
- IoU maps  
- saliency evaluations  
- CSV results  

Supports:
- single-image explanations  
- full test set evaluation  
- ablation analysis across background types

---

### **b. N2_DrawPlot_from_CSV.ipynb**
Used to generate **boxplots** (Figure 14 in the paper):

- Loads CSV files  
- Computes AUC / IoU distributions  
- Saves visualizations inside `results/boxplots/`  

Example output:  
`results/boxplots/results_table_IoU_110_10_blurred.pdf`

---

### **c. N3_Create_HTML_File.ipynb**
Generates complete **HTML visual reports**, containing:

- combined heatmaps  
- per-method IoU curves  
- comparative saliency evaluation

Example outputs:

- `results/HTML_CelebA_blurred.html`  
- `results/HTML_CelebA_blurred_IoU.html`  

---

## **2. Results Folder ‚Äì `results/`**

The results folder contains multiple subfolders:

### **`csv/`**
Contains per-image CSV files, generated by `N1_Run_experiments_CelebA.ipynb`, such as:
- IoU scores  
- AUC curves  
- MSE curves  
- saliency pixel statistics  

Each CSV corresponds to a specific:
- image  
- attribute  
- background replacement type  

---

### **`boxplots/`**
Contains precomputed boxplots for the paper (e.g., Figure 14).  

Each plot shows comparisons across:
- ShapBPT  
- AxisAligned SHAP  
- Gradient-based methods  
- LIME  
- IDG  
- GradSHAP  
- etc.

---

### **`selected/`**
This folder stores selected outputs used to produce **Figure 13** in the supplementary materials.

Contains:
- representative heatmaps  
- IoU maps  
- per-attribute comparisons  

---

### **HTML Files**
All visual analysis HTML files are saved here after running:

```
N3_Create_HTML_File.ipynb
```

---

# üìù Notebook Usage Instructions

## **1. Run Single Example**

Use:

```
notebooks/CelebA_experiments/N1_Run_experiments_CelebA.ipynb
```

This computes:
- heatmaps  
- IoU  
- saliency curves  
- CSV metrics  

for a manually selected image.

---

## **2. Run Full Test Set**

In the same notebook:

- Set `background_type` in **Cell #32**
- Set:

```
run_full_test = True
```

in **Cell #56**

This processes **the entire CelebA-HQ validation set** for the selected background value:

Supported backgrounds:
```
'black', 'white', 'gray', 'noise', 'full', 'blurred'
```

---

## **3. Run Full Ablation Analysis**

Enable:

```
run_ablation_analysis = True
```

in **Cell #59**, then run **Cell #60**.

This evaluates *all background types* and computes:

- all saliency maps  
- IoU maps  
- CSV summaries  
- evaluation metrics  

‚è≥ **Expected runtime**: ~10 hours.

---

## **4. Generate Boxplots from CSV Files**

Use:

```
notebooks/CelebA_experiments/N2_DrawPlot_from_CSV.ipynb
```

Select your background type in **Cell #7**.  
This will generate all boxplots and save them into:

```
results/boxplots/
```

---

## **5. Generate HTML Summary Reports**

Use:

```
notebooks/CelebA_experiments/N3_Create_HTML_File.ipynb
```

It loads:

- computed heatmaps from `results/bg_<type>/`  
- CSV files from `results/csv/`  

and outputs:

- `HTML_CelebA_<bg>.html`  
- `HTML_CelebA_<bg>_IoU.html`

---

# üñºÔ∏è Example Output (Single Image)

Below is an example result for the **Brown Hair** attribute using **gray background replacement**.

### üîπ Combined Heatmaps (All Methods)

<div>
    <table>
    <tr>
        <td style="text-align: center;">Input</td>
        <td style="text-align: center;">GT</td>
        <td style="text-align: center;">BPT-100</td>
        <td style="text-align: center;">BPT-500</td>
        <td style="text-align: center;">BPT-1000</td>
        <td style="text-align: center;">AA-100</td>
        <td style="text-align: center;">AA-500</td>
        <td style="text-align: center;">AA-1000</td>
        <td style="text-align: center;">LIME-50</td>
        <td style="text-align: center;">LIME-100</td>
        <td style="text-align: center;">LIME-200</td>
        <td style="text-align: center;">LRP</td>
        <td style="text-align: center;">GradCAM</td>
        <td style="text-align: center;">IDG</td>
        <td style="text-align: center;">GradExp</td>
        <td style="text-align: center;">GradShap</td>
    </tr>
    <tr>
        <td colspan="16"><img src='results/bg_gray/0_Brown_Hair_gray_heatmaps.png' width=100%></td>
    </tr>
    <tr>
        <td colspan="16"><img src='results/bg_gray/0_Brown_Hair_gray_iou.png'></td>
    </tr>
    </table>
</div>
 
